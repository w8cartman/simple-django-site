pipeline {

    agent none

    stages {
        stage('Build') {
	    agent { label 'Slave1' }
            steps {
		sh "pip3 install -r mysite/requirements.txt"
		sh "python3 mysite/manage.py migrate"
                echo 'Building..'
            }
        }

        stage('Test') {
	    agent { label 'Slave1' }
	    steps {
		sh "python3 mysite/manage.py test mainApp"
                echo 'Testing..'
            }
        }

        stage('Staging') {
	    agent { label 'Slave2' }
            steps {
		echo "Deploying"
		sh "pip3 install -r mysite/requirements.txt"
		sh "nohup python3 mysite/manage.py runserver 0.0.0.0:8000 &"
            }
        }
    }


post {
      success {
        node('master') {
           telegramSend "Job \"${JOB_NAME}\": Build №${BUILD_NUMBER} Succeed. More info: ${BUILD_URL}"
         }
      }
      failure {
        node('master') {
           telegramSend "Job \"${JOB_NAME}\": Build №${BUILD_NUMBER} Failed. More info: ${BUILD_URL}"
         }
      }
   }
}
